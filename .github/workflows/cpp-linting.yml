name: C++ Linter

on:
  push:
    paths:
      - '**.cpp'
      - '!**-og**'

jobs:
  linter:
    name: â˜‘ Linter
    runs-on: ubuntu-latest
    timeout-minutes: 1
    
    steps:
      - name: â†§ Checkout
        uses: actions/checkout@v3
        with:
          fetch-depth: 2
        
      - name: ğŸ’¬ Get commit message
        id: get-cm
        uses: rlespinasse/git-commit-data-action@v1
        
        
      - name: ğŸ” Check for [del] in CM
        id: regex-del
        uses: AsasInnab/regex-action@v1
        with:
          regex_pattern: '(\[del\]\ )'
          regex_flags: 'gm'
          search_string: '${{ env.GIT_COMMIT_MESSAGE_SUBJECT }}'
          
      - name: â›” CM contains [del]
        id: del-exit
        if: steps.regex-del.outputs.first_match != ''
        continue-on-error: true
        run: exit 1
        

      - name: ğŸ—’ Get changed files
        id: targets
        if: steps.regex-del.outputs.first_match == ''
        uses: tj-actions/changed-files@v18.6
        with:
          files: |
            **/*.cpp
            !**-og**
      

      - name: âš™ï¸ Install cppcheck
        id: instl
        if: steps.targets.outcome == 'success' && ${{ steps.targets.outputs.any_changed }}
        run: sudo apt install cppcheck
        
      - name: ğŸ” Linting
        id: linter
        if: steps.instl.outcome == 'success'
        continue-on-error: true
        run: |
          for changed_file in ${{ steps.targets.outputs.all_changed_files }}; do
            cppcheck --enable=all --inconclusive --library=posix --std=c++20 --error-exitcode=1 --output-file="lint.txt" "${changed_file}"
          done
        
        
      - name: âœ Create new issue
        if: steps.linter.outcome == 'failure'
        uses: peter-evans/create-issue-from-file@v3
        with:
          title: "Linting error: ${{ env.GIT_COMMIT_MESSAGE_SUBJECT }} | ${{ env.GIT_COMMIT_SHORT_SHA }}"
          content-filepath: lint.txt
          labels: lint
          
      - name: âŒ Make job fail
        if: steps.linter.outcome == 'failure'
        run: exit 1